ktor {
    deployment {
        port = 8080
        port = ${?PORT}
    }
    application {
        modules = [ org.example.MainKt.module ]
    }
}

# Environment-specific settings
ktor.environment = "dev" // Default to dev
ktor.environment = ${?KTOR_ENV} // Allow override by KTOR_ENV environment variable

environments {
    dev {
        db {
            driver = "org.h2.Driver"
            url = "jdbc:h2:file:./build/db;DB_CLOSE_DELAY=-1"
            user = ""
            password = ""
            poolSize = 3
        }
        jwt {
            secret = "dev-secret-key-replace-me" // Replace with a secure key, potentially from env vars
            issuer = "mechanic-rating-app-dev"
            audience = "mechanic-rating-users-dev"
            validityMs = 36000000 // 10 hours
        }
        cors {
            allowedHosts = ["localhost:3000", "127.0.0.1:3000"] // Example dev frontend hosts
            allowedSchemes = ["http", "https"]
        }
    }
    test {
         db {
            driver = "org.h2.Driver"
            url = "jdbc:h2:mem:test;DB_CLOSE_DELAY=-1" // In-memory H2 for tests
            user = ""
            password = ""
            poolSize = 1
        }
        jwt {
            secret = "test-secret-key"
            issuer = "mechanic-rating-app-test"
            audience = "mechanic-rating-users-test"
            validityMs = 60000 // 1 minute for tests
        }
        cors {
            allowedHosts = ["*"] // Allow any host for simple testing if needed, or restrict
            allowedSchemes = ["http", "https"]
        }
    }
    prod {
         db {
            driver = "org.postgresql.Driver" // Example: PostgreSQL
            url = "jdbc:postgresql://db.example.com:5432/prod_db" // Placeholder - Use env vars
            url = ${?JDBC_DATABASE_URL} // Best practice: Override with environment variable
            user = ${?JDBC_DATABASE_USERNAME}
            password = ${?JDBC_DATABASE_PASSWORD}
            poolSize = 10
        }
        jwt {
            secret = ${?JWT_SECRET} // MUST be set via environment variable
            issuer = "mechanic-rating-app"
            audience = "mechanic-rating-users"
            validityMs = 36000000 // 10 hours
        }
        cors {
            allowedHosts = ["your-frontend-domain.com"] // Replace with your actual frontend domain(s)
            allowedHosts = ${?CORS_ALLOWED_HOSTS} // Optional: Override via env var (comma-separated)
            allowedSchemes = ["https"] // Enforce HTTPS in production
        }
    }
}

// Removed the manual environment merging below.
// Ktor automatically merges the correct environment based on ktor.environment.